services:
  # -------------------------------------
  # üóÑ Database (MySQL cho Backend)
  # -------------------------------------
  db:
    image: mysql:8.0
    restart: always
    environment:
      MYSQL_DATABASE: ${DB_NAME}
      MYSQL_USER: ${DB_USER}
      MYSQL_PASSWORD: ${DB_PASSWORD}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      TZ: Asia/Ho_Chi_Minh
      LANG: en_US.UTF-8
    command: >
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
    volumes:
      - db_data:/var/lib/mysql
    ports:
      - "3307:3306"
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h localhost -u${DB_USER} -p${DB_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - codebattle_net

  # -------------------------------------
  # üìù Redis (H√†ng ƒë·ª£i Celery)
  # -------------------------------------
  redis:
    image: redis:7-alpine
    restart: always
    command: ["redis-server", "--appendonly", "yes"]
    environment:
      - TZ=Asia/Ho_Chi_Minh
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - codebattle_net

  # -------------------------------------
  # üß† Backend (Django + Daphne)
  # -------------------------------------
  backend:
    build:
      context: ./backend
    image: codebattle-backend-image:latest 
    working_dir: /app
    command: daphne -b 0.0.0.0 -p 8000 code_battle_api.asgi:application
    restart: always
    volumes:
      - ./backend:/app
    ports:
      - "8000:8000"
    env_file:
      - ./backend/.env
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - codebattle_net

  # -------------------------------------
  # ‚öôÔ∏è Celery Worker
  # -------------------------------------
  worker:
    image: codebattle-backend-image:latest
    working_dir: /app
    command: celery -A code_battle_api worker --loglevel=info
    restart: always
    volumes:
      - ./backend:/app
      - /var/run/docker.sock:/var/run/docker.sock
    env_file:
      - ./backend/.env
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
      backend:
        condition: service_started
    networks:
      - codebattle_net

  # -------------------------------------
  # üñ•Ô∏è Frontend (React/Vite)
  # -------------------------------------
  frontend:
    image: node:18-alpine
    working_dir: /app
    volumes:
      - ./frontend:/app
      - frontend_node_modules:/app/node_modules
    ports:
      - "5173:5173"
    command: sh -c "npm install && npm run dev -- --host 0.0.0.0"
    networks:
      - codebattle_net
    depends_on:
      - backend

  # -------------------------------------
  # üß© Judge0 Database (PostgreSQL)
  # -------------------------------------
  judge0_db:
    image: postgres:13-alpine
    restart: always
    environment:
      POSTGRES_USER: ${JUDGE0_DB_USER}
      POSTGRES_PASSWORD: ${JUDGE0_DB_PASS}
      POSTGRES_DB: ${JUDGE0_DB_NAME}
    volumes:
      - judge0_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${JUDGE0_DB_USER} -d ${JUDGE0_DB_NAME}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - codebattle_net

  # -------------------------------------
  # üì¶ Judge0 Redis
  # -------------------------------------
  judge0_redis:
    image: redis:7.2.0-alpine
    command: ["redis-server", "--appendonly", "yes", "--requirepass", "${JUDGE0_REDIS_PASS}"]
    restart: always
    volumes:
      - judge0_redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${JUDGE0_REDIS_PASS}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - codebattle_net

  # -------------------------------------
  # ‚öñÔ∏è Judge0 API Server (FIXED - Windows Compatible)
  # -------------------------------------
  judge0_server:
    image: judge0/judge0:1.13.0
    container_name: codebattle-judge0_server
    privileged: true 
    restart: always
    environment:
      PORT: "2358"
      RAILS_ENV: production
      SECRET_KEY_BASE: ${JUDGE0_SECRET_KEY_BASE}
      RAILS_MAX_THREADS: ${RAILS_MAX_THREADS}
      RAILS_SERVER_PROCESSES: ${RAILS_SERVER_PROCESSES:-2}
      WEB_CONCURRENCY: ${WEB_CONCURRENCY}
      RAILS_SERVE_STATIC_FILES: "true"
      POSTGRES_HOST: judge0_db
      POSTGRES_PORT: "5432"
      POSTGRES_DB: ${JUDGE0_DB_NAME}
      POSTGRES_USER: ${JUDGE0_DB_USER}
      POSTGRES_PASSWORD: ${JUDGE0_DB_PASS}
      REDIS_HOST: judge0_redis
      REDIS_PORT: "6379"
      REDIS_PASSWORD: ${JUDGE0_REDIS_PASS}
      USE_ISOLATE: "true"
    volumes:
      - judge0_boxes:/box
      - ./judge0/fake-isolate.sh:/tmp/fake-isolate.sh:ro
    command: bash -c "
      rm -f /api/tmp/pids/server.pid;
      export RAILS_MAX_THREADS=${RAILS_MAX_THREADS};
      export RAILS_SERVER_PROCESSES=${RAILS_SERVER_PROCESSES:-2};
      export WEB_CONCURRENCY=${WEB_CONCURRENCY};
      unset DATABASE_URL;
      echo 'üîß Installing fake isolate wrapper (no sandbox mode)...';
      cp /tmp/fake-isolate.sh /usr/local/bin/isolate;
      chmod +x /usr/local/bin/isolate;
      echo '‚úÖ Fake isolate wrapper installed';
      echo 'üöÄ Running database setup for Judge0...';
      bundle install --quiet;
      bundle exec rails db:create db:migrate db:seed 2>/dev/null || true;
      echo '‚úÖ Database ready, starting Judge0 server...';
      rails server -b 0.0.0.0 -p 2358"
    ports:
      - "2358:2358"
    depends_on:
      judge0_db:
        condition: service_healthy
      judge0_redis:
        condition: service_healthy
    networks:
      - codebattle_net

  # -------------------------------------
  # ‚öñÔ∏è Judge0 Worker (FIXED - Windows Compatible)
  # -------------------------------------
  judge0_worker:
    image: judge0/judge0:1.13.0
    container_name: codebattle-judge0_worker
    privileged: true
    restart: always
    environment:
      WORKER: "true"
      RAILS_ENV: production
      SECRET_KEY_BASE: ${JUDGE0_SECRET_KEY_BASE}
      RAILS_MAX_THREADS: ${RAILS_MAX_THREADS}
      RAILS_SERVER_PROCESSES: ${RAILS_SERVER_PROCESSES:-2}
      POSTGRES_HOST: judge0_db
      POSTGRES_PORT: "5432"
      POSTGRES_DB: ${JUDGE0_DB_NAME}
      POSTGRES_USER: ${JUDGE0_DB_USER}
      POSTGRES_PASSWORD: ${JUDGE0_DB_PASS}
      REDIS_HOST: judge0_redis
      REDIS_PORT: "6379"
      REDIS_PASSWORD: ${JUDGE0_REDIS_PASS}
      USE_ISOLATE: "true"
    volumes:
      - judge0_boxes:/box
    depends_on:
      judge0_db:
        condition: service_healthy
      judge0_redis:
        condition: service_healthy
      judge0_server:
        condition: service_started
    networks:
      - codebattle_net

# -------------------------------------
# üì¶ D·ªØ li·ªáu & M·∫°ng
# -------------------------------------
volumes:
  db_data:
  redis_data:
  judge0_postgres_data:
  judge0_redis_data:
  judge0_boxes:
  frontend_node_modules:

networks:
  codebattle_net:
    driver: bridge
    name: codebattle_network