services:
  # -------------------------------------
  #  üóÑ D·ªãch v·ª• Database (MySQL)
  # -------------------------------------
  db:
    image: mysql:8.0
    restart: always
    environment:
      MYSQL_DATABASE: ${DB_NAME}
      MYSQL_USER: ${DB_USER}
      MYSQL_PASSWORD: ${DB_PASSWORD}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      TZ: Asia/Ho_Chi_Minh
      LANG: en_US.UTF-8
    command: >
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
    volumes:
      - db_data:/var/lib/mysql
    ports:
      - "3307:3306"
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h localhost -u${DB_USER} -p${DB_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - codebattle_net

  # -------------------------------------
  #  üîÅ Redis (H√†ng ƒë·ª£i Celery)
  # -------------------------------------
  redis:
    image: redis:7-alpine
    restart: always
    command: ["redis-server", "--appendonly", "yes"]
    environment:
      - TZ=Asia/Ho_Chi_Minh
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - codebattle_net

  # -------------------------------------
  #  üß† Backend (Django + Daphne)
  # -------------------------------------
  backend:
    build:
      context: ./backend
    working_dir: /app
    command: daphne -b 0.0.0.0 -p 8000 code_battle_api.asgi:application
    restart: always
    volumes:
      - ./backend:/app
    ports:
      - "8000:8000"
    env_file:
      - ./backend/.env
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - codebattle_net

  # -------------------------------------
  #  ‚öôÔ∏è Celery Worker (M√°y ch·∫•m n·ªôi b·ªô)
  # -------------------------------------
  worker:
    build:
      context: ./backend
    working_dir: /app
    command: celery -A code_battle_api worker --loglevel=info
    restart: always
    volumes:
      - ./backend:/app
      # N·∫øu worker c·ªßa B·∫†N c·∫ßn d√πng Docker, h√£y gi·ªØ d√≤ng n√†y.
      # N·∫øu kh√¥ng, h√£y x√≥a n√≥ ƒë·ªÉ tƒÉng b·∫£o m·∫≠t.
      - /var/run/docker.sock:/var/run/docker.sock
    env_file:
      - ./backend/.env
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - codebattle_net

  # -------------------------------------
  #  üñ•Ô∏è Frontend (React/Vite Dev)
  # -------------------------------------
  frontend:
    image: node:18-alpine
    # Gi·∫£ ƒë·ªãnh code frontend n·∫±m trong th∆∞ m·ª•c ./frontend
    working_dir: /app
    volumes:
      - ./frontend:/app
      # D√πng volume ƒë·ªÉ cache node_modules, gi√∫p 'npm install' nhanh h∆°n
      - frontend_node_modules:/app/node_modules
    # Gi·∫£ ƒë·ªãnh port 5173 (Vite)
    ports:
      - "5173:5173"
    # L·ªánh ƒë·ªÉ c√†i ƒë·∫∑t v√† ch·∫°y dev server
    # C·∫ßn '--host 0.0.0.0' ƒë·ªÉ expose ra ngo√†i container
    command: sh -c "npm install && npm run dev -- --host 0.0.0.0"
    networks:
      - codebattle_net
    depends_on:
      - backend

  # -------------------------------------
  #  üß© Judge0 Database (PostgreSQL)
  # -------------------------------------
  judge0_db:
    image: postgres:13-alpine
    restart: always
    environment:
      # S·ª≠ d·ª•ng bi·∫øn t·ª´ file .env
      POSTGRES_USER: ${JUDGE0_DB_USER}
      POSTGRES_PASSWORD: ${JUDGE0_DB_PASS}
      POSTGRES_DB: ${JUDGE0_DB_NAME}
    volumes:
      - judge0_postgres_data:/var/lib/postgresql/data
    networks:
      - codebattle_net

  # -------------------------------------
  #  üì¶ Judge0 Redis
  # -------------------------------------
  judge0_redis:
    image: redis:7.2.0-alpine
    # S·ª≠ d·ª•ng bi·∫øn t·ª´ file .env
    command: ["redis-server", "--appendonly", "yes", "--requirepass", "${JUDGE0_REDIS_PASS}"]
    restart: always
    volumes:
      - judge0_redis_data:/data
    networks:
      - codebattle_net

  # -------------------------------------
  #  ‚öñÔ∏è Judge0 API Server (Build t·ª´ source)
  # -------------------------------------
  judge0_server:
    build:
      context: ./judge0
      dockerfile: Dockerfile
    container_name: codebattle-judge0_server
    privileged: true # C·∫¶N THI·∫æT ƒë·ªÉ ch·∫°y sandbox 'isolate'
    restart: always
    environment:
      - PORT=2358
      - REDIS_HOST=judge0_redis
      - REDIS_PASSWORD=${JUDGE0_REDIS_PASS} # Th√™m m·∫≠t kh·∫©u Redis
      # S·ª≠a DATABASE_URL ƒë·ªÉ kh·ªõp v·ªõi credentials c·ªßa judge0_db
      - DATABASE_URL=postgresql://${JUDGE0_DB_USER}:${JUDGE0_DB_PASS}@judge0_db:5432/${JUDGE0_DB_NAME}
      - RAILS_ENV=production
      - DISABLE_ISOLATE_CGROUPS=true # Th√™m c·ªù fix cgroup v2
      # ƒê√É X√ìA 'ENABLE_SANDBOX=false' -> M·∫∂C ƒê·ªäNH S·∫º L√Ä TRUE (AN TO√ÄN)
    ports:
      - "2358:2358"
    depends_on:
      - judge0_db
      - judge0_redis
    networks:
      - codebattle_net

  # -------------------------------------
  #  ‚öñÔ∏è Judge0 Worker (Build t·ª´ source)
  # -------------------------------------
  judge0_worker:
    build:
      context: ./judge0
      dockerfile: Dockerfile
    container_name: codebattle-judge0_worker
    privileged: true # C·∫¶N THI·∫æT ƒë·ªÉ ch·∫°y sandbox 'isolate'
    restart: always
    environment:
      - WORKER=true
      - REDIS_HOST=judge0_redis
      - REDIS_PASSWORD=${JUDGE0_REDIS_PASS} # Th√™m m·∫≠t kh·∫©u Redis
      # S·ª≠a DATABASE_URL ƒë·ªÉ kh·ªõp v·ªõi credentials c·ªßa judge0_db
      - DATABASE_URL=postgresql://${JUDGE0_DB_USER}:${JUDGE0_DB_PASS}@judge0_db:5432/${JUDGE0_DB_NAME}
      - RAILS_ENV=production
      - DISABLE_ISOLATE_CGROUPS=true # Th√™m c·ªù fix cgroup v2
    depends_on:
      - judge0_server # Worker n√™n kh·ªüi ƒë·ªông sau server
    networks:
      - codebattle_net

# =====================================
# üì¶ D·ªØ li·ªáu l∆∞u tr·ªØ & m·∫°ng n·ªôi b·ªô
# =====================================
volumes:
  db_data:
  redis_data:
  judge0_postgres_data:
  judge0_redis_data:
  frontend_node_modules: # <-- ƒê√£ th√™m volume cho frontend

networks:
  codebattle_net:
    driver: bridge
    name: codebattle_network

